<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stick-Bee Kalkulator</title>

    <!-- Mobile Web App Settings (iOS Fallback) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3393/3393989.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3393/3393989.png">

    <!-- PWA Manifest (Datei muss im Root liegen) -->
    <link rel="manifest" href="/manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    /* Entfernt Pfeile bei number-Inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 selection:bg-blue-500 selection:text-white">
  <div id="root"></div>

  <!-- Application Logic (React mit Babel) -->
  <script type="text/babel" data-type="module">
    import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { Calculator, AlertCircle, Check, Minus, Plus, FileText, RefreshCcw, Settings2 } from 'https://esm.sh/lucide-react@0.292.0';

    // --- Konfiguration ---
    const CONFIG = {
      mwst: 0.19,
      preise: [
        { max: 10, preis: 5.5, label: "XS (bis 10cm)" },
        { max: 15, preis: 6.5, label: "S (bis 15cm)" },
        { max: 20, preis: 7.5, label: "M (bis 20cm)" },
        { max: 25, preis: 8.5, label: "L (bis 25cm)" },
        { max: 30, preis: 9.5, label: "XL (bis 30cm)" },
        { max: 35, preis: 10.5, label: "XXL (bis 35cm)" },
      ],
      rabatte: [
        { min: 1000, faktor: 0.3, label: "-70%" },
        { min: 500, faktor: 0.35, label: "-65%" },
        { min: 250, faktor: 0.45, label: "-55%" },
        { min: 100, faktor: 0.6, label: "-40%" },
        { min: 50, faktor: 0.7, label: "-30%" },
        { min: 20, faktor: 0.8, label: "-20%" },
        { min: 10, faktor: 0.9, label: "-10%" },
        { min: 1, faktor: 1.0, label: "0%" },
      ],
      techniken: {
        dtf: { label: "DTF / Transfer", faktor: 1.0, desc: "Standard" },
        flex: { label: "Flex / Flock", faktor: 1.2, desc: "+20% (Handarbeit)" },
      },
      extraKosten: { grafik: 20.0, datei: 25.0, fremdware: 1.5 },
      faktoren: { reflektor: 1.2, wiederverkaeufer: 0.8, farbStep: 0.25 },
    };

    const formatEUR = (val) => new Intl.NumberFormat("de-DE", { style: "currency", currency: "EUR" }).format(val);

    function calculatePrice(state) {
      const { laenge, breite, stueckzahl, farben, technik, extras } = state;
      const maxKante = Math.max(laenge, breite);
      const staffel = CONFIG.preise.find((s) => maxKante <= s.max);
      if (!staffel) return { error: "Größe überschreitet Standardmaße (max 35cm)." };

      const grundpreis = staffel.preis;
      const farbAnzahl = Math.min(Math.max(1, farben), 3);
      const farbFaktor = 1 + CONFIG.faktoren.farbStep * (farbAnzahl - 1);
      const gewaehlteTechnik = CONFIG.techniken[technik] ? technik : "dtf";
      const technikFaktor = CONFIG.techniken[gewaehlteTechnik].faktor;
      const reflektorFaktor = extras.reflektor ? CONFIG.faktoren.reflektor : 1.0;
      const rabattStaffel = CONFIG.rabatte.find((r) => stueckzahl >= r.min) || { faktor: 1, label: "0%" };
      const mengenFaktor = rabattStaffel.faktor;

      let einzelVeredelung = grundpreis * farbFaktor * technikFaktor * reflektorFaktor * mengenFaktor;
      if (extras.wiederverkaeufer) einzelVeredelung *= CONFIG.faktoren.wiederverkaeufer;

      const fremdwareZuschlag = extras.fremdware ? CONFIG.extraKosten.fremdware : 0;
      const einzelNetto = einzelVeredelung + fremdwareZuschlag;
      const gesamtNettoStueck = einzelNetto * stueckzahl;

      const fixkosten = (extras.grafik ? CONFIG.extraKosten.grafik : 0) + (extras.datei ? CONFIG.extraKosten.datei : 0);

      const totalNetto = gesamtNettoStueck + fixkosten;
      const totalBrutto = totalNetto * (1 + CONFIG.mwst);

      return {
        details: {
          staffelLabel: staffel.label,
          grundpreis,
          rabattLabel: rabattStaffel.label,
          einzelNetto,
          fixkosten,
        },
        totalNetto,
        totalBrutto,
        error: null
      };
    }

    // --- Local Storage Persistenz ---
    const LOCAL_STORAGE_KEY = 'stickbee_calc_state';
    const DEFAULT_STATE = {
      laenge: 10, breite: 10, stueckzahl: 10, farben: 1, technik: "dtf",
      extras: { grafik: false, datei: false, fremdware: false, wiederverkaeufer: false, reflektor: false }
    };

    const loadState = () => {
      try {
        const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!raw) return DEFAULT_STATE;
        const s = JSON.parse(raw);
        const numericState = {
          ...s,
          laenge: parseFloat(s.laenge) > 0 ? parseFloat(s.laenge) : DEFAULT_STATE.laenge,
          breite: parseFloat(s.breite) > 0 ? parseFloat(s.breite) : DEFAULT_STATE.breite,
          stueckzahl: parseInt(s.stueckzahl) > 0 ? parseInt(s.stueckzahl) : DEFAULT_STATE.stueckzahl,
          farben: parseInt(s.farben) > 0 ? parseInt(s.farben) : DEFAULT_STATE.farben,
        };
        return {
          ...DEFAULT_STATE,
          ...numericState,
          extras: { ...DEFAULT_STATE.extras, ...numericState.extras }
        };
      } catch {
        return DEFAULT_STATE;
      }
    };

    const saveState = (state) => {
      try {
        if (state.laenge > 0 && state.breite > 0 && state.stueckzahl > 0) {
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
        }
      } catch {}
    };

    // --- UI Komponenten ---
    const NumberControl = ({ label, value, onChange, min = 1, max = 35, step = 0.5, suffix = "" }) => {
      const intervalRef = useRef(null);
      const timeoutRef = useRef(null);
      const valueRef = useRef(value);

      useEffect(() => { valueRef.current = value; }, [value]);

      const stopHold = () => {
        if (timeoutRef.current) {
          clearTimeout(timeoutRef.current);
          timeoutRef.current = null;
        }
        if (intervalRef.current) {
          clearInterval(intervalRef.current);
          intervalRef.current = null;
        }
      };

      useEffect(() => stopHold, []);

      const handleChange = (newVal) => {
        let v = parseFloat(newVal);
        if (isNaN(v)) return;
        if (max !== undefined && v > max) v = max;
        if (v < min) v = min;
        onChange(v);
      };

      const startHold = (direction) => {
        // Sofort 1x ausführen
        handleChange(value + direction * step);
        // Dann nach kurzer Verzögerung schnell weiterlaufen lassen
        timeoutRef.current = setTimeout(() => {
          intervalRef.current = setInterval(() => {
            handleChange(valueRef.current + direction * step);
          }, 45);
        }, 250);
      };

      const displayValue = typeof value === 'number'
        ? (Number.isInteger(value) ? value : value.toFixed(1))
        : value;

      const onMinusDown = (e) => { e.preventDefault(); stopHold(); startHold(-1); };
      const onPlusDown = (e) => { e.preventDefault(); stopHold(); startHold(1); };

      const holdProps = (onDown) => ({
        onPointerDown: onDown,
        onPointerUp: stopHold,
        onPointerLeave: stopHold,
        onPointerCancel: stopHold,
        onContextMenu: (e) => e.preventDefault(),
      });

      return (
        <div className="flex flex-col gap-1.5">
          <label className="text-xs font-medium text-slate-400 uppercase tracking-wider">{label}</label>
          <div className="flex items-center bg-slate-900 rounded-lg border border-slate-700 p-1">
            <button
              type="button"
              aria-label={`Reduziere ${label}`}
              {...holdProps(onMinusDown)}
              className="w-10 h-10 shrink-0 flex items-center justify-center rounded bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition active:scale-95 touch-manipulation"
            >
              <Minus size={16} />
            </button>

            <div class="flex-1 h-10 flex items-center justify-center overflow-hidden">
  <div class="flex items-center">
    <input
      class="w-full bg-transparent text-center text-lg text-white outline-none"
      type="number"
      inputMode={step < 1 ? "decimal" : "numeric"}
      value={displayValue}
      step={step}
      min={min}
      max={max}
      onChange={(e) => handleChange(e.target.value)}
      onBlur={(e) => handleChange(e.target.value)}
      onFocus={(e) => e.target.select()}
      aria-label={label}
    />
    {suffix && (
      <span class="text-slate-500 text-sm ml-0.5">{suffix}</span>
    )}
  </div>
</div>

            <button
              type="button"
              aria-label={`Erhöhe ${label}`}
              {...holdProps(onPlusDown)}
              className="w-10 h-10 shrink-0 flex items-center justify-center rounded bg-slate-800 text-slate-300 hover:bg-blue-600 hover:text-white transition active:scale-95 touch-manipulation"
            >
              <Plus size={16} />
            </button>
          </div>
        </div>
      );
    };

    const Toggle = ({ label, checked, onChange, priceInfo }) => (
      <div onClick={() => onChange(!checked)} className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-all duration-200 touch-manipulation ${checked ? "bg-blue-900/20 border-blue-500/50" : "bg-slate-800/50 border-slate-700 hover:border-slate-600"}`}>
        <div className="flex flex-col">
          <span className={`text-sm font-medium ${checked ? "text-blue-200" : "text-slate-300"}`}>{label}</span>
          {priceInfo && <span className="text-xs text-slate-500">{priceInfo}</span>}
        </div>
        <div className={`w-10 h-6 rounded-full relative transition-colors ${checked ? "bg-blue-500" : "bg-slate-600"}`}>
          <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform duration-200 ${checked ? "left-5" : "left-1"}`} />
        </div>
      </div>
    );

    const ResultFooter = ({ result, handleReset }) => {
      if (result.error) return null;
      return (
        <div id="result-footer" className="sticky bottom-0 w-full mt-6 bg-slate-800 border-t border-slate-700 shadow-[0_-5px_20px_rgba(0,0,0,0.5)] z-20">
          <div className="max-w-xl mx-auto p-4 flex items-center justify-between">
            <div>
              <h2 className="text-slate-400 text-xs uppercase tracking-widest font-bold">Gesamtsumme (inkl. MwSt.)</h2>
              <div className="text-2xl font-bold text-white tracking-tight">{formatEUR(result.totalBrutto)}</div>
            </div>
            <button onClick={handleReset} className="flex items-center gap-2 px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition active:scale-95 shadow-md shadow-blue-900/40 touch-manipulation shrink-0" aria-label="Kalkulator zurücksetzen">
              <RefreshCcw size={18} /> Zurücksetzen
            </button>
          </div>
        </div>
      );
    };

    function App() {
      const [state, setState] = useState(loadState());
      useEffect(() => saveState(state), [state]);

      const updateExtra = (key) => setState(s => ({ ...s, extras: { ...s.extras, [key]: !s.extras[key] } }));
      const result = useMemo(() => calculatePrice(state), [state]);
      const hasError = !!result.error;

      const handleReset = () => {
        setState(DEFAULT_STATE);
        localStorage.removeItem(LOCAL_STORAGE_KEY);
      };

      return (
        <div className="min-h-screen p-4 md:p-8 flex flex-col items-center font-sans pb-8">
          <div className="w-full max-w-xl">
            <div className="flex items-center gap-3 mb-6">
              <div className="p-3 bg-blue-600 rounded-xl shadow-lg shadow-blue-900/20"><Calculator className="text-white" size={24} /></div>
              <div><h1 className="text-2xl font-bold text-white">Stick-Bee Kalkulator</h1><p className="text-slate-400 text-sm">Preise für Textilveredelung berechnen</p></div>
            </div>

            <div className="flex flex-col gap-6">
              <div className="space-y-6">
                <div className="bg-slate-900 border border-slate-800 rounded-2xl p-5 shadow-sm">
                  <div className="flex items-center gap-2 mb-4 text-white font-semibold"><Settings2 size={18} className="text-blue-400" /><span>Basisdaten</span></div>
                  <div className="flex flex-col sm:grid sm:grid-cols-2 gap-4 sm:gap-5">
                    <NumberControl label="Länge (cm)" value={state.laenge} step={0.5} onChange={(v) => setState(s => ({...s, laenge: v}))} min={1} max={35} />
                    <NumberControl label="Stückzahl" value={state.stueckzahl} min={1} max={1000}  step={1} onChange={(v) => setState(s => ({ ...s, stueckzahl: v }))} />
                    <NumberControl label="Breite (cm)" value={state.breite} step={0.5} onChange={(v) => setState(s => ({...s, breite: v}))} min={1} max={35} />
                    <NumberControl label="Farben" value={state.farben} min={1} max={3} step={1}  onChange={(v) => setState(s => ({...s, farben: v}))} />
                  </div>
                  <div className="mt-6">
                    <label className="text-xs font-medium text-slate-400 uppercase tracking-wider mb-2 block">Drucktechnik</label>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {Object.entries(CONFIG.techniken).map(([key, tech]) => (
                        <button key={key} onClick={() => setState(s => ({...s, technik: key}))} className={`p-3 rounded-lg border text-left transition-all touch-manipulation ${state.technik === key ? "bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-900/20" : "bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-800/80"}`}>
                          <div className="font-bold text-sm">{tech.label}</div>
                          <div className={`text-xs mt-1 ${state.technik === key ? "text-blue-200" : "text-slate-500"}`}>{tech.desc}</div>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="bg-slate-900 border border-slate-800 rounded-2xl p-5 shadow-sm">
                  <div className="flex items-center gap-2 mb-4 text-white font-semibold"><FileText size={18} className="text-blue-400" /><span>Optionen & Service</span></div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <Toggle label="Grafikbearbeitung" checked={state.extras.grafik} onChange={() => updateExtra('grafik')} priceInfo={`+${formatEUR(CONFIG.extraKosten.grafik)} pauschal`} />
                    <Toggle label="Dateiaufbereitung" checked={state.extras.datei} onChange={() => updateExtra('datei')} priceInfo={`+${formatEUR(CONFIG.extraKosten.datei)} pauschal`} />
                    <Toggle label="Reflektor-Material" checked={state.extras.reflektor} onChange={() => updateExtra('reflektor')} priceInfo="+20% Aufschlag" />
                    <Toggle label="Fremdware" checked={state.extras.fremdware} onChange={() => updateExtra('fremdware')} priceInfo={`+${formatEUR(CONFIG.extraKosten.fremdware)} / Stück`} />
                    <Toggle label="Wiederverkäufer" checked={state.extras.wiederverkaeufer} onChange={() => updateExtra('wiederverkaeufer')} priceInfo="-20% auf Veredelung" />
                  </div>
                </div>
              </div>

              <div className="mb-6">
                {hasError ? (
                  <div className="bg-red-500/10 border border-red-500/50 rounded-2xl p-6 text-red-200 flex flex-col items-center text-center"><AlertCircle size={48} className="mb-3 text-red-500" /><h3 className="text-lg font-bold text-white">Kalkulation nicht möglich</h3><p className="text-sm mt-1">{result.error}</p><button onClick={() => setState(s => ({...s, laenge: 10, breite: 10}))} className="mt-4 px-4 py-2 bg-red-500/20 hover:bg-red-500/30 rounded text-sm font-medium transition touch-manipulation">Maße zurücksetzen</button></div>
                ) : (
                  <div className="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden shadow-xl p-5">
                    <h3 className="text-lg font-bold text-white mb-4">Berechnungsdetails</h3>

                    {result.details.rabattLabel !== "0%" && (
                      <div className="flex items-center gap-2 text-emerald-400 bg-emerald-400/10 p-3 rounded-lg border border-emerald-400/20 text-sm mb-4"><Check size={16} /><span className="font-medium">Mengenrabatt angewendet: {result.details.rabattLabel}</span></div>
                    )}

                    <div className="bg-slate-950/40 border border-slate-800 rounded-xl p-4 mb-4 grid grid-cols-2 gap-y-3 text-sm">
                      <span className="text-slate-300">Grundpreis (Staffel: {result.details.staffelLabel})</span>
                      <span className="text-right font-semibold text-slate-200">{formatEUR(result.details.grundpreis)}</span>

                      <span className="text-slate-400">Stückpreis Veredelung (netto)</span>
                      <span className="text-right font-semibold text-white">{formatEUR(result.details.einzelNetto)}</span>

                      <span className="text-slate-400">Stückzahl</span>
                      <span className="text-right text-white">× {state.stueckzahl}</span>

                      {result.details.fixkosten > 0 && (
                        <>
                          <span className="text-amber-200 border-t border-slate-700/50 pt-2 mt-2">+ Fixkosten (Grafik/Datei)</span>
                          <span className="text-right font-semibold text-amber-200 border-t border-slate-700/50 pt-2 mt-2">{formatEUR(result.details.fixkosten)}</span>
                        </>
                      )}
                    </div>

                    <div className="bg-slate-950 rounded-lg p-4 space-y-2 mt-4 grid grid-cols-2">
                      <div className="flex justify-between items-center text-slate-400 text-sm col-span-2"><span>Netto gesamt</span><span className="text-right text-lg font-bold text-white">{formatEUR(result.totalNetto)}</span></div>
                      <div className="flex justify-between items-center text-slate-500 text-xs col-span-2"><span>MwSt (19%)</span><span className="text-right">{formatEUR(result.totalBrutto - result.totalNetto)}</span></div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            <ResultFooter result={result} handleReset={handleReset} />
          </div>
        </div>
      );
    }

    createRoot(document.getElementById('root')).render(<App />);
  </script>

  <!-- PWA Service Worker (nur auf HTTPS/localhost, nach Load) -->
  <script>
    (function registerSWWhenSafe(){
      if (!('serviceWorker' in navigator)) return;
      const isAllowedHost = (location.protocol === 'https:' || location.hostname === 'localhost');
      if (!isAllowedHost || !window.isSecureContext) return;
      const doRegister = () => {
        navigator.serviceWorker.register('/service-worker.js').catch(console.error);
      };
      if (document.readyState === 'complete') doRegister();
      else window.addEventListener('load', doRegister, { once: true });
    })();
  </script>
</body>
</html>
